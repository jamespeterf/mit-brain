<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIT Brain</title>
  <link rel="stylesheet" href="css/mit-brain-nav.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f8f8;
      padding-top: 90px;
    }

    .page-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-header {
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .page-header h1 {
      margin: 0 0 10px 0;
      font-size: 2em;
    }

    .page-header p {
      margin: 0;
      opacity: 0.9;
    }

    .widgets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
    }

    .widget-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .widget-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .widget-title {
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .widget-body {
      padding: 20px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #666;
    }

    .stat-value {
      font-weight: 600;
      color: #2c3e50;
    }

    .recent-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recent-list li {
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .recent-list li:last-child {
      border-bottom: none;
    }

    .recent-list a {
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
    }

    .recent-list a:hover {
      text-decoration: underline;
    }

    .recent-list .meta {
      font-size: 0.85em;
      color: #888;
      margin-top: 4px;
    }

    .kind-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.75em;
      font-weight: 500;
    }

    .kind-article { background: #e3f2fd; color: #1565c0; }
    .kind-video { background: #fce4ec; color: #c2185b; }
    .kind-paper { background: #e8f5e9; color: #2e7d32; }
    .kind-person { background: #fff3e0; color: #ef6c00; }
    .kind-startup { background: #f3e5f5; color: #7b1fa2; }
    .kind-future_event { background: #e0f7fa; color: #00838f; }

    .loading {
      text-align: center;
      padding: 30px;
      color: #888;
    }

    .error {
      color: #e74c3c;
      text-align: center;
      padding: 20px;
    }

    .refresh-btn {
      background: none;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      color: #666;
      font-size: 0.85em;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: #f8f9fa;
      border-color: #3498db;
      color: #3498db;
    }

    .chart-container {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 10px 0;
    }

    .chart-bar {
      flex: 1;
      background: linear-gradient(180deg, #3498db, #2980b9);
      border-radius: 4px 4px 0 0;
      min-height: 10px;
      position: relative;
    }

    .chart-bar:hover {
      opacity: 0.8;
    }

    .chart-bar .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #2c3e50;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      white-space: nowrap;
      margin-bottom: 5px;
    }

    .chart-bar:hover .tooltip {
      display: block;
    }

    .chart-labels {
      display: flex;
      gap: 8px;
    }

    .chart-labels span {
      flex: 1;
      text-align: center;
      font-size: 0.75em;
      color: #888;
    }
  </style>
</head>
<body class="has-fixed-nav">

<!-- UNIVERSAL NAVIGATION -->
<nav class="mit-brain-nav">
  <div class="mit-brain-nav-container">
    <a href="/" class="mit-brain-logo">
      <span class="mit-brain-logo-icon">üß†</span>
      <div>
        <div class="mit-brain-logo-text">MIT Brain</div>
        <div class="mit-brain-logo-subtitle">Corporate Relations Intelligence</div>
      </div>
    </a>

    <div class="mit-brain-nav-links">
      <a href="/" class="mit-brain-nav-link nav-home active">
        üè† <span>Home</span>
      </a>
      <a href="/search.html" class="mit-brain-nav-link nav-search">
        üîç <span>Search</span>
      </a>
      <a href="/alerts-dashboard.html" class="mit-brain-nav-link nav-alerts">
        üîî <span>Alerts</span>
      </a>
      <a href="/create-alert.html" class="mit-brain-nav-link nav-create">
        ‚ûï <span>Create Alert</span>
      </a>
      <a href="/meetings.html" class="mit-brain-nav-link nav-meetings">
        üìù <span>Meetings</span>
      </a>
      <a href="/virtual-pd.html" class="mit-brain-nav-link nav-virtualpd">
        üéì <span>Virtual PD</span>
      </a>
      <a href="/settings.html" class="mit-brain-nav-link nav-settings">
        ‚öôÔ∏è <span>Settings</span>
      </a>
      <a href="/admin.html" class="mit-brain-nav-link nav-admin">
        üõ†Ô∏è <span>Admin</span>
      </a>
    </div>
  </div>
</nav>

<!-- Spacer for fixed nav -->
<div style="height: 80px;"></div>

<div class="page-container">
  <div class="page-header">
    <h1>üß† MIT Brain Dashboard</h1>
    <p>Quick insights and statistics from your MIT Brain data</p>
  </div>

  <div class="widgets-grid">
    <!-- Data Overview Widget -->
    <div class="widget-card">
      <div class="widget-header">
        <div class="widget-title">üìä MIT Brain Data Overview</div>
        <button class="refresh-btn" onclick="loadOverview()">Refresh</button>
      </div>
      <div class="widget-body" id="overviewWidget">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Content by Kind Widget -->
    <div class="widget-card">
      <div class="widget-header">
        <div class="widget-title">üìà Content Distribution</div>
      </div>
      <div class="widget-body" id="distributionWidget">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Recent Articles Widget -->
    <div class="widget-card">
      <div class="widget-header">
        <div class="widget-title">üì∞ Recent Articles</div>
        <button class="refresh-btn" onclick="loadRecentArticles()">Refresh</button>
      </div>
      <div class="widget-body" id="recentArticlesWidget">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Recent Videos Widget -->
    <div class="widget-card">
      <div class="widget-header">
        <div class="widget-title">üé¨ Recent Videos</div>
        <button class="refresh-btn" onclick="loadRecentVideos()">Refresh</button>
      </div>
      <div class="widget-body" id="recentVideosWidget">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Recent Papers Widget -->
    <div class="widget-card">
      <div class="widget-header">
        <div class="widget-title">üìÑ Recent Papers</div>
        <button class="refresh-btn" onclick="loadRecentPapers()">Refresh</button>
      </div>
      <div class="widget-body" id="recentPapersWidget">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Top Sources Widget -->
    <div class="widget-card">
      <div class="widget-header">
        <div class="widget-title">üåê Top Sources</div>
      </div>
      <div class="widget-body" id="topSourcesWidget">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <!-- Upcoming Events Widget -->
    <div class="widget-card">
      <div class="widget-header">
        <div class="widget-title">üìÖ Upcoming Events</div>
        <button class="refresh-btn" onclick="loadUpcomingEvents()">Refresh</button>
      </div>
      <div class="widget-body" id="upcomingEventsWidget">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
  let reportData = null;
  // Dashboard data loaded from pre-calculated server cache

  // Load all widgets on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadAllWidgets();
  });

  let dashboardRecent = null; // Cached recent items from server

  async function loadAllWidgets() {
    try {
      // Fetch report data for overview stats
      const reportResponse = await fetch('/api/admin/jsonl-report');
      const reportJson = await reportResponse.json();

      if (!reportResponse.ok) {
        throw new Error(reportJson.error || 'Failed to load report data');
      }

      reportData = reportJson.report;

      // Fetch pre-calculated recent items (fast, lightweight endpoint)
      const recentResponse = await fetch('/api/dashboard-recent');
      dashboardRecent = await recentResponse.json();

      renderOverview();
      renderDistribution();
      renderTopSources();
      renderRecentArticles();
      renderRecentVideos();
      renderRecentPapers();
      renderUpcomingEvents();
    } catch (error) {
      console.error('Error loading widgets:', error);
      document.querySelectorAll('.widget-body').forEach(el => {
        el.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      });
    }
  }

  function loadOverview() {
    if (reportData) {
      renderOverview();
    } else {
      loadAllWidgets();
    }
  }

  function renderOverview() {
    const el = document.getElementById('overviewWidget');
    const { summary, file, dateRange, contentStats } = reportData;

    el.innerHTML = `
      <div class="stat-row">
        <span class="stat-label">Total Objects</span>
        <span class="stat-value">${summary.totalObjects.toLocaleString()}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">File Size</span>
        <span class="stat-value">${file.sizeMB} MB</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">With Full Text</span>
        <span class="stat-value">${contentStats.withFullText.toLocaleString()}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">With Summary</span>
        <span class="stat-value">${contentStats.withSummary.toLocaleString()}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Date Range</span>
        <span class="stat-value" style="font-size: 0.85em;">${dateRange.earliest || 'N/A'} - ${dateRange.latest || 'N/A'}</span>
      </div>
    `;
  }

  function renderDistribution() {
    const el = document.getElementById('distributionWidget');
    const { byKind, summary } = reportData;

    const maxCount = Math.max(...byKind.map(k => k.count));

    el.innerHTML = `
      <div class="chart-container">
        ${byKind.map(k => `
          <div class="chart-bar" style="height: ${(k.count / maxCount) * 100}%;">
            <div class="tooltip">${formatKindName(k.kind)}: ${k.count.toLocaleString()} (${k.percentage}%)</div>
          </div>
        `).join('')}
      </div>
      <div class="chart-labels">
        ${byKind.map(k => `<span>${formatKindName(k.kind).substring(0, 6)}</span>`).join('')}
      </div>
    `;
  }

  function renderTopSources() {
    const el = document.getElementById('topSourcesWidget');
    const { topSources } = reportData;

    el.innerHTML = topSources.slice(0, 8).map(s => `
      <div class="stat-row">
        <span class="stat-label">${s.source}</span>
        <span class="stat-value">${s.count.toLocaleString()}</span>
      </div>
    `).join('');
  }

  function loadRecentArticles() {
    renderRecentArticles();
  }

  function loadRecentVideos() {
    renderRecentVideos();
  }

  function loadUpcomingEvents() {
    renderUpcomingEvents();
  }

  function renderRecentArticles() {
    const el = document.getElementById('recentArticlesWidget');
    if (!dashboardRecent) {
      el.innerHTML = '<div class="loading">Loading...</div>';
      return;
    }

    const articles = dashboardRecent.recentArticles || [];

    if (articles.length > 0) {
      el.innerHTML = `
        <ul class="recent-list">
          ${articles.map(item => `
            <li>
              <a href="${item.url || '#'}" target="_blank">${truncate(item.title, 60)}</a>
              <div class="meta">${item.source || 'Unknown'} ‚Ä¢ ${item.publishedAt || 'No date'}</div>
            </li>
          `).join('')}
        </ul>
      `;
    } else {
      el.innerHTML = '<div class="loading">No recent articles found</div>';
    }
  }

  function renderRecentVideos() {
    const el = document.getElementById('recentVideosWidget');
    if (!dashboardRecent) {
      el.innerHTML = '<div class="loading">Loading...</div>';
      return;
    }

    const videos = dashboardRecent.recentVideos || [];

    if (videos.length > 0) {
      el.innerHTML = `
        <ul class="recent-list">
          ${videos.map(item => `
            <li>
              <a href="${item.url || '#'}" target="_blank">${truncate(item.title, 60)}</a>
              <div class="meta">${item.source || 'YouTube'} ‚Ä¢ ${formatDuration(item.durationSeconds)}</div>
            </li>
          `).join('')}
        </ul>
      `;
    } else {
      el.innerHTML = '<div class="loading">No recent videos found</div>';
    }
  }

  function loadRecentPapers() {
    renderRecentPapers();
  }

  function renderRecentPapers() {
    const el = document.getElementById('recentPapersWidget');
    if (!dashboardRecent) {
      el.innerHTML = '<div class="loading">Loading...</div>';
      return;
    }

    const papers = dashboardRecent.recentPapers || [];

    if (papers.length > 0) {
      el.innerHTML = `
        <ul class="recent-list">
          ${papers.map(item => `
            <li>
              <a href="${item.url || '#'}" target="_blank">${truncate(item.title, 60)}</a>
              <div class="meta">${item.source || 'arXiv'} ‚Ä¢ ${item.publishedAt || 'No date'}</div>
            </li>
          `).join('')}
        </ul>
      `;
    } else {
      el.innerHTML = '<div class="loading">No recent papers found</div>';
    }
  }

  function renderUpcomingEvents() {
    const el = document.getElementById('upcomingEventsWidget');
    if (!dashboardRecent) {
      el.innerHTML = '<div class="loading">Loading...</div>';
      return;
    }

    const events = dashboardRecent.upcomingEvents || [];

    if (events.length > 0) {
      el.innerHTML = `
        <ul class="recent-list">
          ${events.map(item => `
            <li>
              <a href="${item.url || '#'}" target="_blank">${truncate(item.title, 60)}</a>
              <div class="meta">${item.date || 'TBD'}${item.location ? ' ‚Ä¢ ' + item.location : ''}</div>
            </li>
          `).join('')}
        </ul>
      `;
    } else {
      el.innerHTML = '<div class="loading">No upcoming events</div>';
    }
  }

  function formatKindName(kind) {
    const names = {
      'article': 'Articles',
      'video': 'Videos',
      'paper': 'Papers',
      'person': 'People',
      'startup': 'Startups',
      'future_event': 'Events'
    };
    return names[kind] || kind;
  }

  function truncate(str, len) {
    if (!str) return '';
    return str.length > len ? str.substring(0, len) + '...' : str;
  }

  function formatDuration(seconds) {
    if (!seconds) return 'Unknown duration';
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }
</script>
<script src="/js/auth.js"></script>
</body>
</html>
